<div class="row justify-content-center">
  <div class="col-12 col-md-8 col-lg-6">

    <div class="card shadow-sm">
      <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center gap-2">
          <% if @post.user&.avatar&.attached? %>
            <%= image_tag @post.user.avatar, class: "avatar-sm" %>
          <% else %>
            <div class="avatar-sm bg-secondary-subtle d-flex align-items-center justify-content-center">
              <i class="bi bi-person"></i>
            </div>
          <% end %>

          <div class="small">
            <div class="fw-semibold">
              <%= link_to (@post.user&.username || @post.user&.email), user_path(@post.user), class: "text-decoration-none text-dark" %>
            </div>
            <div class="text-muted">
              <%= @post.created_at.strftime("%Y/%m/%d %H:%M") %>
            </div>
          </div>
        </div>
      </div>

      <div class="card-body p-0">
        <% if @post.image.attached? %>
          <div class="post-image-wrap">
            <%= image_tag @post.image, class: "img-fluid w-100 d-block post-image" %>
          </div>
        <% end %>
      </div>

      <div class="card-body">
        <% if @post.tags.any? %>
          <div class="d-flex flex-wrap gap-1 mb-2">
            <% @post.tags.each do |tag| %>
              <%= link_to "##{tag.name}", tag_path(tag.name),
                class: "badge rounded-pill text-bg-light border text-decoration-none" %>
            <% end %>
          </div>
        <% end %>

        <% if @post.content.present? %>
          <p class="mb-2"><%= simple_format(@post.content) %></p>
        <% else %>
          <p class="text-muted mb-2">本文はありません</p>
        <% end %>

        <div class="d-flex align-items-center gap-2 mb-3">
          <% if user_signed_in? %>
            <%= render "likes/button", post: @post %>
            <span class="small text-muted"><%= @post.likes_count %></span>
          <% end %>
        </div>

        <% if user_signed_in? && @post.user == current_user %>
          <div class="d-flex gap-2 mb-2">
            <%= link_to "編集", edit_post_path(@post), class: "btn btn-sm btn-outline-secondary" %>
            <%= button_to "削除", post_path(@post), method: :delete,
                  data: { turbo_confirm: "削除しますか？" },
                  class: "btn btn-sm btn-outline-danger" %>
          </div>
        <% end %>

        <%= link_to "一覧へ戻る", posts_path, class: "btn btn-outline-secondary btn-sm" %>
      </div>


    <div class="mt-4">
      <h5>コメント</h5>

      <% if user_signed_in? %>
        <% if @comment&.errors&.any? %>
          <div class="alert alert-danger">
            <ul class="mb-0">
              <% @comment.errors.full_messages.each do |message| %>
                <li><%= message %></li>
              <% end %>
            </ul>
          </div>
        <% end %>

        <%= form_with model: [@post, Comment.new], local: true do |f| %>
          <div class="mb-2">
            <%= f.text_area :content, rows: 2, class: "form-control", placeholder: "コメントを入力..." %>
          </div>
          <%= f.submit "送信", class: "btn btn-primary btn-sm" %>
        <% end %>
      <% else %>
        <p><%= link_to "ログイン", new_user_session_path %>するとコメントできます</p>
      <% end %>

      <hr>

      <% @post.comments.order(created_at: :desc).each do |comment| %>
        <div class="mb-2">
          <strong><%= comment.user.username || "名無しユーザー" %></strong>
          <span class="text-muted small">（<%= comment.created_at.strftime("%Y/%m/%d %H:%M") %>）</span>
          <p class="mb-1"><%= simple_format(comment.content) %></p>

          <% if user_signed_in? && comment.user == current_user %>
            <%= button_to "削除", post_comment_path(@post, comment),
                        method: :delete,
                        data: { confirm: "削除しますか？" },
                        class: "btn btn-sm btn-outline-danger" %>
          <% end %>
        </div>
      <% end %>
    </div>

  </div>
</div>
